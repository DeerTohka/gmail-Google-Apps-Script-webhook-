// ==================== é£ä¹¦æœºå™¨äººé…ç½® ====================
var FEISHU_CONFIG = {
  // ã€å¿…å¡«ã€‘é£ä¹¦ç¾¤æœºå™¨äººçš„Webhookåœ°å€
  WEBHOOK_URL: 'https://open.feishu.cn/open-apis/bot/v2/hook/ced677c5-a1eb-4bbc-97a1-973a041d23d2',
  
  // ã€å¯é€‰ã€‘ç­¾åå¯†é’¥ï¼ˆå¦‚æœé£ä¹¦æœºå™¨äººå¼€å¯äº†ç­¾åæ ¡éªŒï¼‰
  SECRET: '',
  
  // ã€å¿…å¡«ã€‘æ¶ˆæ¯ç±»å‹ï¼š'interactive'(æ¨è)ã€'text'ã€'post'
  MSG_TYPE: 'interactive',
  
  // ã€å¯é€‰ã€‘æ¶ˆæ¯æ ‡é¢˜é¢œè‰²ï¼ˆä»…interactiveç±»å‹æœ‰æ•ˆï¼‰
  HEADER_COLOR: 'blue',
  
  // ã€å¯é€‰ã€‘æ˜¯å¦@ç‰¹å®šç”¨æˆ·ï¼ˆå¡«å†™ç”¨æˆ·IDï¼‰
  AT_USERS: [],
  
  // ã€å¯é€‰ã€‘æ˜¯å¦@æ‰€æœ‰äºº
  AT_ALL: false,
  
  // ã€å¯é€‰ã€‘é‚®ä»¶å†…å®¹æˆªæ–­é•¿åº¦
  MAX_CONTENT_LENGTH: 1500,
  
  // ã€å¯é€‰ã€‘è°ƒè¯•æ¨¡å¼
  DEBUG_MODE: true,
  
  // ========== ã€æ–°å¢ã€‘é‚®ä»¶ç­›é€‰è§„åˆ™é…ç½® ==========
  FILTER_RULES: {
    // å‘ä»¶äººç™½åå•ï¼ˆæ”¯æŒå®Œæ•´é‚®ç®±æˆ–åŸŸåï¼Œå¦‚ï¼š'@company.com'åŒ¹é…æ•´ä¸ªåŸŸåï¼‰
    senders: [ ],
    
    // ä¸»é¢˜å…³é”®è¯ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼ŒORå…³ç³»ï¼‰
    subjectKeywords: ['netflix', 'æš«æ™‚å­˜å–ç¢¼'],
    
    // æ­£æ–‡å…³é”®è¯ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼ŒORå…³ç³»ï¼‰
    bodyKeywords: ['netflix', 'æš«æ™‚å­˜å–ç¢¼'],
    
    // åŒ¹é…æ¨¡å¼ï¼š'OR'(ä»»ä¸€æ¡ä»¶æ»¡è¶³) æˆ– 'AND'(æ‰€æœ‰æ¡ä»¶æ»¡è¶³)
    matchMode: 'OR',
    
    // æ˜¯å¦åªå¤„ç†æœªè¯»é‚®ä»¶
    onlyUnread: true,
    
    // æ˜¯å¦åœ¨å¤„ç†åå°†é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»
    markAsRead: true,
    
    // æœ€å¤§å¤„ç†é‚®ä»¶æ•°ï¼ˆé˜²æ­¢è¶…æ—¶ï¼‰
    maxEmails: 20
  }
};

// ==================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====================

/**
 * ä¸»å‡½æ•°ï¼šå°†ç¬¦åˆæ¡ä»¶çš„é‚®ä»¶è½¬å‘åˆ°é£ä¹¦
 */
function forwardEmailsToFeishu() {
  logDebug('å¼€å§‹æ‰§è¡Œé‚®ä»¶ç­›é€‰è½¬å‘ä»»åŠ¡...');
  
  // 1. æ„å»ºé‚®ä»¶æœç´¢æ¡ä»¶
  var searchQuery = buildFilterSearchQuery();
  logDebug('æœç´¢æ¡ä»¶: ' + (searchQuery || 'æ— ç­›é€‰æ¡ä»¶'));
  
  // 2. æœç´¢é‚®ä»¶
  var threads = GmailApp.search(searchQuery, 0, FEISHU_CONFIG.FILTER_RULES.maxEmails);
  logDebug('æ‰¾åˆ° ' + threads.length + ' å°ç¬¦åˆæ¡ä»¶çš„é‚®ä»¶');
  
  if (threads.length === 0) {
    logDebug('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é‚®ä»¶ï¼Œä»»åŠ¡ç»“æŸ');
    return { success: 0, failed: 0, total: 0 };
  }
  
  var processedCount = 0;
  var errorCount = 0;
  
  // 3. å¤„ç†æ¯å°é‚®ä»¶
  for (var i = 0; i < threads.length; i++) {
    var messages = threads[i].getMessages();
    
    for (var j = 0; j < messages.length; j++) {
      var message = messages[j];
      
      try {
        logDebug('å¤„ç†é‚®ä»¶: ' + message.getSubject());
        
        // æå–é‚®ä»¶æ•°æ®ï¼ˆåŒ…å«é“¾æ¥è½¬æ¢ï¼‰
        var emailData = extractEmailForFeishu(message);
        
        // å‘é€åˆ°é£ä¹¦
        var success = sendToFeishuWebhook(emailData);
        
        if (success) {
          if (FEISHU_CONFIG.FILTER_RULES.markAsRead) {
            message.markRead();
          }
          processedCount++;
          logDebug('æˆåŠŸå‘é€åˆ°é£ä¹¦: ' + message.getSubject());
        } else {
          errorCount++;
          logDebug('å‘é€å¤±è´¥: ' + message.getSubject());
        }
        
        Utilities.sleep(500); // é¿å…è¯·æ±‚è¿‡å¿«
        
      } catch (error) {
        errorCount++;
        logDebug('å¤„ç†é‚®ä»¶æ—¶å‡ºé”™: ' + error.toString());
      }
    }
  }
  
  // 4. å‘é€æ±‡æ€»é€šçŸ¥
  if (processedCount > 0) {
    sendSummaryNotification(processedCount, errorCount, threads.length);
  }
  
  logDebug('ä»»åŠ¡å®Œæˆã€‚æˆåŠŸ: ' + processedCount + ', å¤±è´¥: ' + errorCount);
  return {
    success: processedCount,
    failed: errorCount,
    total: threads.length
  };
}

/**
 * æ ¹æ®ç­›é€‰è§„åˆ™æ„å»ºGmailæœç´¢æŸ¥è¯¢
 */
function buildFilterSearchQuery() {
  var rules = FEISHU_CONFIG.FILTER_RULES;
  var queryParts = [];
  
  // æ„å»ºå‘ä»¶äººæ¡ä»¶
  if (rules.senders && rules.senders.length > 0) {
    var senderQueries = rules.senders.map(function(sender) {
      return sender.startsWith('@') ? 'from:*' + sender : 'from:' + sender;
    });
    queryParts.push('(' + senderQueries.join(' OR ') + ')');
  }
  
  // æ„å»ºä¸»é¢˜æ¡ä»¶
  if (rules.subjectKeywords && rules.subjectKeywords.length > 0) {
    var subjectQueries = rules.subjectKeywords.map(function(keyword) {
      return 'subject:' + keyword;
    });
    queryParts.push('(' + subjectQueries.join(' OR ') + ')');
  }
  
  // æ„å»ºæ­£æ–‡æ¡ä»¶
  if (rules.bodyKeywords && rules.bodyKeywords.length > 0) {
    var bodyQueries = rules.bodyKeywords.map(function(keyword) {
      return '"' + keyword + '"';
    });
    queryParts.push('(' + bodyQueries.join(' OR ') + ')');
  }
  
  // ç»„åˆæ‰€æœ‰æ¡ä»¶
  var finalQuery = '';
  if (queryParts.length > 0) {
    var connector = (rules.matchMode === 'AND') ? ' AND ' : ' OR ';
    finalQuery = queryParts.join(connector);
  }
  
  // æ·»åŠ æœªè¯»æ¡ä»¶
  if (rules.onlyUnread) {
    if (finalQuery) {
      finalQuery = '(' + finalQuery + ') AND is:unread';
    } else {
      finalQuery = 'is:unread';
    }
  }
  
  // å¦‚æœæ²¡æœ‰è®¾ç½®ä»»ä½•æ¡ä»¶ï¼Œé»˜è®¤ä¸åŒ¹é…ä»»ä½•é‚®ä»¶
  if (!finalQuery) {
    finalQuery = 'subject:"__NO_MATCH__"';
  }
  
  return finalQuery;
}

/**
 * æå–é‚®ä»¶æ•°æ®å¹¶è½¬æ¢é“¾æ¥
 */
function extractEmailForFeishu(message) {
  // è·å–é‚®ä»¶åŸºæœ¬ä¿¡æ¯
  var from = message.getFrom();
  var to = message.getTo();
  var subject = message.getSubject();
  var date = message.getDate();
  var htmlBody = message.getBody();
  var plainBody = message.getPlainBody() || 'ï¼ˆæ— æ­£æ–‡å†…å®¹ï¼‰';
  
  // å¤„ç†é“¾æ¥ï¼šå°†HTMLä¸­çš„<a>æ ‡ç­¾è½¬æ¢ä¸ºMarkdownæ ¼å¼
  var processedBody = '';
  if (htmlBody) {
    // è½¬æ¢é“¾æ¥ï¼š<a href="URL">TEXT</a> -> [TEXT](URL)
    processedBody = htmlBody.replace(/<a\s+(?:[^>]*?\s+)?href="([^"]*)"[^>]*>([\s\S]*?)<\/a>/gi, '[$2]($1)');
    // ç§»é™¤å‰©ä½™çš„HTMLæ ‡ç­¾
    processedBody = processedBody.replace(/<[^>]+>/g, '');
    // å¤„ç†HTMLå®ä½“
    processedBody = processedBody.replace(/&nbsp;/g, ' ')
                                .replace(/&amp;/g, '&')
                                .replace(/&lt;/g, '<')
                                .replace(/&gt;/g, '>');
  } else {
    processedBody = plainBody;
  }
  
  // æˆªæ–­è¿‡é•¿çš„æ­£æ–‡
  if (processedBody.length > FEISHU_CONFIG.MAX_CONTENT_LENGTH) {
    processedBody = processedBody.substring(0, FEISHU_CONFIG.MAX_CONTENT_LENGTH) + '...ï¼ˆå†…å®¹å·²æˆªæ–­ï¼‰';
  }
  
  // è·å–é™„ä»¶ä¿¡æ¯
  var attachments = message.getAttachments();
  var attachmentInfo = [];
  var maxAttachments = Math.min(attachments.length, 3);
  
  for (var k = 0; k < maxAttachments; k++) {
    var att = attachments[k];
    attachmentInfo.push({
      name: att.getName(),
      size: formatFileSize(att.getSize()),
      type: att.getContentType()
    });
  }
  
  // è§£æå‘ä»¶äºº
  var fromMatch = from.match(/(?:["']?([^"']+)["']?\s*)?<?([^<>]+@[^<>]+)>?/);
  var senderName = fromMatch && fromMatch[1] ? fromMatch[1].trim() : '';
  var senderEmail = fromMatch && fromMatch[2] ? fromMatch[2].trim() : from;
  
  return {
    id: message.getId(),
    threadId: message.getThread().getId(),
    senderName: senderName,
    senderEmail: senderEmail,
    to: to,
    subject: subject,
    body: processedBody,
    htmlBody: htmlBody,
    date: date,
    attachments: attachmentInfo,
    hasMoreAttachments: attachments.length > 3,
    timestamp: new Date().toISOString()
  };
}

/**
 * å‘é€é‚®ä»¶æ•°æ®åˆ°é£ä¹¦Webhookï¼ˆæ”¯æŒç­¾åæ ¡éªŒï¼‰
 */
function sendToFeishuWebhook(emailData) {
  try {
    // æ„å»ºé£ä¹¦æ¶ˆæ¯
    var feishuMessage = buildFeishuMessage(emailData);
    
    // ç”Ÿæˆæœ€ç»ˆURLï¼ˆå¦‚æœå¯ç”¨äº†ç­¾åï¼‰
    var finalWebhookUrl = FEISHU_CONFIG.WEBHOOK_URL;
    if (FEISHU_CONFIG.SECRET) {
      finalWebhookUrl = generateSignedFeishuUrl(FEISHU_CONFIG.WEBHOOK_URL, FEISHU_CONFIG.SECRET);
    }
    
    // å‡†å¤‡è¯·æ±‚é€‰é¡¹
    var options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(feishuMessage),
      muteHttpExceptions: true,
      timeout: 15000
    };
    
    logDebug('å‘é€è¯·æ±‚åˆ°é£ä¹¦: ' + finalWebhookUrl);
    
    // å‘é€è¯·æ±‚
    var response = UrlFetchApp.fetch(finalWebhookUrl, options);
    var responseCode = response.getResponseCode();
    var responseText = response.getContentText();
    
    logDebug('é£ä¹¦å“åº”çŠ¶æ€ç : ' + responseCode);
    logDebug('é£ä¹¦å“åº”å†…å®¹: ' + responseText);
    
    // è§£æå“åº”
    if (responseCode === 200) {
      var result = JSON.parse(responseText);
      if (result.StatusCode === 0 || result.code === 0) {
        logDebug('é£ä¹¦æ¶ˆæ¯å‘é€æˆåŠŸ');
        return true;
      } else {
        logDebug('é£ä¹¦è¿”å›ä¸šåŠ¡é”™è¯¯: ' + JSON.stringify(result));
        return false;
      }
    } else {
      logDebug('HTTPè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + responseCode);
      return false;
    }
    
  } catch (error) {
    logDebug('å‘é€åˆ°é£ä¹¦æ—¶å‘ç”Ÿå¼‚å¸¸: ' + error.toString());
    return false;
  }
}

/**
 * ç”Ÿæˆå¸¦ç­¾åçš„é£ä¹¦Webhook URL
 */
function generateSignedFeishuUrl(webhookUrl, secret) {
  var timestamp = Math.floor(Date.now() / 1000); // ç§’çº§æ—¶é—´æˆ³
  var stringToSign = timestamp + "\n" + secret;
  var sign = Utilities.computeHmacSha256Signature(stringToSign, secret);
  var signBase64 = Utilities.base64Encode(sign);
  
  return webhookUrl + "?timestamp=" + timestamp + "&sign=" + encodeURIComponent(signBase64);
}

/**
 * æ„å»ºé£ä¹¦æ¶ˆæ¯
 */
function buildFeishuMessage(emailData) {
  var msgType = FEISHU_CONFIG.MSG_TYPE;
  
  switch (msgType) {
    case 'text':
      return buildTextMessage(emailData);
    case 'post':
      return buildPostMessage(emailData);
    case 'interactive':
    default:
      return buildInteractiveCard(emailData);
  }
}

/**
 * æ„å»ºäº¤äº’å¡ç‰‡æ¶ˆæ¯ï¼ˆæ¨èï¼‰
 */
function buildInteractiveCard(emailData) {
  var card = {
    msg_type: 'interactive',
    card: {
      config: {
        wide_screen_mode: true,
        enable_forward: true
      },
      header: {
        title: {
          tag: 'plain_text',
          content: 'ğŸ“§ æ–°é‚®ä»¶é€šçŸ¥'
        },
        template: FEISHU_CONFIG.HEADER_COLOR
      },
      elements: []
    }
  };
  
  // é‚®ä»¶ä¿¡æ¯
  var infoContent = '**å‘ä»¶äºº:** ' + 
                   (emailData.senderName ? emailData.senderName + ' ' : '') +
                   '<' + emailData.senderEmail + '>\n\n' +
                   '**æ”¶ä»¶äºº:** ' + emailData.to + '\n\n' +
                   '**ä¸»é¢˜:** ' + emailData.subject + '\n\n' +
                   '**æ—¶é—´:** ' + formatDateForDisplay(emailData.date);
  
  card.card.elements.push({
    tag: 'div',
    text: {
      tag: 'lark_md',
      content: infoContent
    }
  });
  
  // åˆ†å‰²çº¿
  card.card.elements.push({ tag: 'hr' });
  
  // é‚®ä»¶æ­£æ–‡ï¼ˆé“¾æ¥å·²è½¬æ¢ä¸ºå¯ç‚¹å‡»æ ¼å¼ï¼‰
  card.card.elements.push({
    tag: 'div',
    text: {
      tag: 'lark_md',
      content: emailData.body
    }
  });
  
  // é™„ä»¶ä¿¡æ¯
  if (emailData.attachments.length > 0) {
    card.card.elements.push({ tag: 'hr' });
    
    var attachmentText = '**é™„ä»¶:**\n';
    for (var i = 0; i < emailData.attachments.length; i++) {
      var att = emailData.attachments[i];
      attachmentText += 'â€¢ ' + att.name + ' (' + att.size + ')\n';
    }
    
    if (emailData.hasMoreAttachments) {
      attachmentText += 'â€¢ ...è¿˜æœ‰' + (emailData.attachments.length - 3) + 'ä¸ªé™„ä»¶';
    }
    
    card.card.elements.push({
      tag: 'div',
      text: {
        tag: 'lark_md',
        content: attachmentText
      }
    });
  }
  
  // åº•éƒ¨å¤‡æ³¨
  card.card.elements.push({
    tag: 'note',
    elements: [{
      tag: 'plain_text',
      content: 'é‚®ä»¶ID: ' + emailData.id.substring(0, 20) + '...'
    }]
  });
  
  // @æé†’
  if (FEISHU_CONFIG.AT_USERS.length > 0 || FEISHU_CONFIG.AT_ALL) {
    card.card.elements.push({
      tag: 'div',
      text: {
        tag: 'lark_md',
        content: buildAtContent()
      }
    });
  }
  
  return card;
}

/**
 * æ„å»ºçº¯æ–‡æœ¬æ¶ˆæ¯
 */
function buildTextMessage(emailData) {
  var content = 'ğŸ“§ æ”¶åˆ°æ–°é‚®ä»¶\n\n' +
                'å‘ä»¶äºº: ' + emailData.senderEmail + '\n' +
                'ä¸»é¢˜: ' + emailData.subject + '\n' +
                'æ—¶é—´: ' + formatDateForDisplay(emailData.date) + '\n\n' +
                'å†…å®¹æ‘˜è¦:\n' + emailData.body.substring(0, 500);
  
  if (emailData.body.length > 500) content += '...';
  
  var message = {
    msg_type: 'text',
    content: {
      text: content + '\n\n' + buildAtContent()
    }
  };
  
  return message;
}

// ==================== è¾…åŠ©å‡½æ•° ====================

/**
 * æ„å»º@æé†’å†…å®¹
 */
function buildAtContent() {
  var atContent = '';
  
  if (FEISHU_CONFIG.AT_ALL) {
    atContent += '<at user_id="all">æ‰€æœ‰äºº</at> ';
  }
  
  FEISHU_CONFIG.AT_USERS.forEach(function(userId) {
    atContent += '<at user_id="' + userId + '"></at> ';
  });
  
  return atContent.trim();
}

/**
 * å‘é€ä»»åŠ¡æ±‡æ€»é€šçŸ¥
 */
function sendSummaryNotification(successCount, errorCount, totalCount) {
  var summaryData = {
    id: 'summary_' + new Date().getTime(),
    senderName: 'Gmailè½¬å‘æœºå™¨äºº',
    senderEmail: 'bot@gmail-forwarder',
    to: 'é£ä¹¦ç¾¤',
    subject: 'é‚®ä»¶è½¬å‘ä»»åŠ¡æŠ¥å‘Š',
    body: 'æœ¬æ¬¡æ‰§è¡Œå…±å‘ç° ' + totalCount + ' å°é‚®ä»¶ã€‚\n' +
          'æˆåŠŸè½¬å‘: ' + successCount + ' å°\n' +
          'å¤„ç†å¤±è´¥: ' + errorCount + ' å°\n' +
          'æ—¶é—´: ' + new Date().toLocaleString(),
    date: new Date(),
    attachments: [],
    hasMoreAttachments: false,
    timestamp: new Date().toISOString()
  };
  
  sendToFeishuWebhook(summaryData);
}

/**
 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
 */
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  var k = 1024;
  var sizes = ['Bytes', 'KB', 'MB', 'GB'];
  var i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
 */
function formatDateForDisplay(date, includeTime) {
  if (!date) return '';
  
  var d = new Date(date);
  var dateStr = d.getFullYear() + '-' + 
                ('0' + (d.getMonth() + 1)).slice(-2) + '-' + 
                ('0' + d.getDate()).slice(-2);
  
  if (includeTime) {
    dateStr += ' ' + ('0' + d.getHours()).slice(-2) + ':' + 
               ('0' + d.getMinutes()).slice(-2) + ':' + 
               ('0' + d.getSeconds()).slice(-2);
  }
  
  return dateStr;
}

/**
 * è°ƒè¯•æ—¥å¿—å‡½æ•°
 */
function logDebug(message) {
  if (FEISHU_CONFIG.DEBUG_MODE) {
    Logger.log('[DEBUG] ' + message);
  }
}

// ==================== æµ‹è¯•å‡½æ•° ====================

/**
 * æµ‹è¯•é£ä¹¦è¿æ¥
 */
function testFeishuConnection() {
  Logger.log('ğŸ”§ å¼€å§‹æµ‹è¯•é£ä¹¦æœºå™¨äººè¿æ¥...');
  
  var testEmailData = {
    id: 'test_' + new Date().getTime(),
    senderName: 'æµ‹è¯•å‘ä»¶äºº',
    senderEmail: 'test@sender.com',
    to: 'your-email@gmail.com',
    subject: 'ğŸ”” é£ä¹¦æœºå™¨äººè¿æ¥æµ‹è¯•',
    body: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼ŒåŒ…å«ä¸€ä¸ªç¤ºä¾‹é“¾æ¥ï¼š[ç‚¹å‡»è¿™é‡Œ](https://example.com)',
    date: new Date(),
    attachments: [],
    hasMoreAttachments: false,
    timestamp: new Date().toISOString()
  };
  
  Logger.log('æµ‹è¯•æ•°æ®å‡†å¤‡å®Œæˆ');
  Logger.log('Webhook URL: ' + FEISHU_CONFIG.WEBHOOK_URL);
  
  var success = sendToFeishuWebhook(testEmailData);
  
  if (success) {
    Logger.log('âœ… æµ‹è¯•æˆåŠŸï¼è¯·æ£€æŸ¥é£ä¹¦ç¾¤æ˜¯å¦æ”¶åˆ°æµ‹è¯•æ¶ˆæ¯ã€‚');
  } else {
    Logger.log('âŒ æµ‹è¯•å¤±è´¥ï¼è¯·æ£€æŸ¥é…ç½®ã€‚');
  }
  
  return success;
}

/**
 * æµ‹è¯•ç­›é€‰è§„åˆ™
 */
function testFilterRules() {
  Logger.log('ğŸ§ª æµ‹è¯•é‚®ä»¶ç­›é€‰è§„åˆ™...');
  
  var rules = FEISHU_CONFIG.FILTER_RULES;
  Logger.log('å½“å‰é…ç½®:');
  Logger.log('- å‘ä»¶äºº: ' + (rules.senders.join(', ') || 'æ— '));
  Logger.log('- ä¸»é¢˜å…³é”®è¯: ' + (rules.subjectKeywords.join(', ') || 'æ— '));
  Logger.log('- æ­£æ–‡å…³é”®è¯: ' + (rules.bodyKeywords.join(', ') || 'æ— '));
  Logger.log('- åŒ¹é…æ¨¡å¼: ' + rules.matchMode);
  
  var searchQuery = buildFilterSearchQuery();
  Logger.log('ç”Ÿæˆçš„æœç´¢è¯­å¥: ' + searchQuery);
  
  var threads = GmailApp.search(searchQuery, 0, 5);
  Logger.log('æ‰¾åˆ° ' + threads.length + ' å°æµ‹è¯•é‚®ä»¶');
  
  for (var i = 0; i < Math.min(threads.length, 3); i++) {
    var messages = threads[i].getMessages();
    if (messages.length > 0) {
      var msg = messages[0];
      Logger.log((i+1) + '. ä¸»é¢˜: "' + msg.getSubject() + '" | å‘ä»¶äºº: ' + msg.getFrom());
    }
  }
}

// ==================== ä½¿ç”¨è¯´æ˜ ====================
// 1. ä¿®æ”¹ FEISHU_CONFIG ä¸­çš„ WEBHOOK_URLï¼ˆå¿…å¡«ï¼‰
// 2. å¦‚æœé£ä¹¦æœºå™¨äººå¯ç”¨äº†ç­¾åæ ¡éªŒï¼Œå¡«å†™ SECRET
// 3. åœ¨ FILTER_RULES ä¸­é…ç½®é‚®ä»¶ç­›é€‰æ¡ä»¶
// 4. è¿è¡Œ testFeishuConnection() æµ‹è¯•è¿æ¥
// 5. è¿è¡Œ forwardEmailsToFeishu() æ‰‹åŠ¨æµ‹è¯•
// 6. é…ç½®è§¦å‘å™¨å®šæœŸæ‰§è¡Œ forwardEmailsToFeishu()
